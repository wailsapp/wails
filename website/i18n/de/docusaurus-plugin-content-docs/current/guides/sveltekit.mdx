# SvelteKit

Diese Anleitung zeigt folgende Dinge:

1. Minimale Installationsschritte – Die erforderlichen Schritte, um eine minimale Wails-Konfiguration für SvelteKit zum Laufen zu bringen.
2. Installationsskript – Bash-Skript zur Durchführung der minimalen Installationsschritte mit optionalem Wails-Branding.
3. Wichtige Hinweise – Probleme, die bei der Verwendung von SvelteKit + Wails auftreten können, und deren Behebung.

## 1. Minimale Installationsschritte

##### Wails für Svelte installieren.

- `wails init -n myapp -t svelte`

##### Lösche das svelte frontend.

- Navigiere in deinen neu erstellten myapp Ordner.
- Lösche den Ordner mit dem Namen "frontend"

##### Gehe in das Wails Stamm Projekt Verzeichnis. Benutze das Svelte CLI, um ein SvelteKit-Projekt als neues Frontend zu erstellen. Folge den Anweisungen, hier ist nichts Wails spezifisch erforderlich.

- `npx sv create frontend`

##### Ändere wails.json.

- Füge `„wailsjsdir“: „./frontend/src/lib“,` hinzu. Beachte, dass hier deine Go- und Laufzeitfunktionen erscheinen werden.
- Ändere hier deinen Frontendpaket-Manager, solltest du npm nicht verwenden.

##### Ändere main.go.

- Der erste Kommentar `//go:embed all:frontend/dist` muss in `//go:embed all:frontend/build` geändert werden

##### Ändere .gitignore

- Die Zeile `frontend/dist` muss durch `frontend/build` ersetzt werden

##### Abhängigkeiten mit deinem bevorzugten Paketmanager installieren/entfernen.

- Navigiere in deinen "Frontend" Ordner.
- `npm i`
- `npm uninstall @sveltejs/adapter-auto`
- `npm i -D @sveltejs/adapter-static`

##### Adapter in svelte.config.js ändern

- Änder in der ersten Zeile der Datei `import adapter from '@sveltejs/adapter-auto';` zu `import adapter from '@sveltejs/adapter-static';`

##### SvelteKit in den SPA-Modus mit prerendering setzen.

- Erstelle eine Datei unter myapp/frontend/src/routes/ mit dem Namen +layout.ts/+layout.js.
- Füge zwei Zeilen in die neu erstellte Datei `export const prerender = true` und `export const ssr = false` hinzu

##### Testinstallation.

- Navigiere zurück zum Wails Stammprojektverzeichnis (ein Verzeichnis oben).
- führe `wails dev` aus
- Falls die Anwendung nicht läuft, überprüfe bitte die vorherigen Schritte.

## 2. Installations Skript

##### Dieses Bash-Skript führt die oben aufgeführten Schritte aus.  Stelle sicher, dass du über das Skript liest und verstehst, was das Skript auf deinem Computer macht.

- Erstelle die Datei sveltekit-wails.sh
- Kopiere den folgenden Code in die neue Datei und speicher diese.
- Mache das Skipt ausführbar mit `chmod +x sveltekit-wails.sh`
- Brand ist ein optionaler Parameter, der das Branding von Wails wieder einfügt.  Lasse den dritten Parameter leer, um das Branding von Wails nicht einzufügen.
- Beispiel Verwendung: `./sveltekit-wails.sh pnpm newapp brand`

##### sveltekit-wails.sh:

```
manager=$1
project=$2
brand=$3
wails init -n $project -t svelte
cd $project
sed -i "s|npm|$manager|g" wails.json
sed -i 's|"auto",|"auto",\n  "wailsjsdir": "./frontend/src/lib",|' wails.json
sed -i "s|all:frontend/dist|all:frontend/build|" main.go
if [[ -n $brand ]]; then
	mv frontend/src/App.svelte +page.svelte
	sed -i "s|'./assets|'\$lib/assets|" +page.svelte
	sed -i "s|'../wails|'\$lib/wails|" +page.svelte
	mv frontend/src/assets .
fi
rm -r frontend
$manager create svelte@latest frontend
if [[ -n $brand ]]; then
	mv +page.svelte frontend/src/routes/+page.svelte
	mkdir frontend/src/lib
	mv assets frontend/src/lib/
fi
cd frontend
$manager i
$manager uninstall @sveltejs/adapter-auto
$manager i -D @sveltejs/adapter-static
echo -e "export const prerender = true\nexport const ssr = false" > src/routes/+layout.ts
sed -i "s|-auto';|-static';|" svelte.config.js
cd ..
wails dev
```

## 3. Wichtige Notizen

##### Serverdateien führen zu Build-Fehlern.

- \+layout.server.ts, +page.server.ts, +server.ts oder jede Datei mit "Server" im Namen wird nicht builden, da alle Routen prerendered werden.

##### Die Wails-Laufzeitumgebung entlädt sich bei vollständiger Seitennavigation!

- Alles, was eine vollständige Seitennavigation verursacht: `window.location.href = '/<some>/<page>'` oder Nachladen des Kontextmenüs bei Verwendung von wails dev.  Das bedeutet, dass du am Ende die Möglichkeit verlieren könnest, jede beliebige Laufzeit Funktion aufzurufen, da diese die App crasht. Es gibt zwei Wege, dies zu umgehen.
- Benutze `import { goto } von '$app/navigation'` und rufe dann `goto('/<some>/<page>')` in deiner +page.svelte auf. Dadurch wird eine vollständige Seitennavigation verhindert.
- Wenn die Ganzseitennavigation nicht verhindert werden kann, kann die Wails-Laufzeit zu allen Seiten hinzugefügt werden, indem die folgende Zeile `<head>` in myapp/frontend/src/app.html eingefügt wird

```
<head>
...
	<meta name="wails-options" content="noautoinject" />
	<script src="/wails/ipc.js"></script>
	<script src="/wails/runtime.js"></script>
...
</head>
```

Siehe https://wails.io/docs/guides/frontend für weitere Informationen.

##### Anfangsdaten können von +page.ts/+page.js bis +page.svelte geladen und aktualisiert werden.

- \+page.ts/+page.js funktioniert gut mit load() https://kit.svelte.dev/docs/load#page-data
- invalidateAll() in +page.svelte ruft load() von +page.ts/+page.js https://kit.svelte.dev/docs/load#rerunning-load-functions-manual-invalidation auf.

##### Fehlerbehandlung

- Erwartete Fehler bei Verwendung von „Throw error“ funktionieren in +page.ts/+page.js mit einer +error.svelte-Seite. https://kit.svelte.dev/docs/errors#erwartete Fehler
- Unerwartete Fehler werden die Anwendung unbrauchbar machen.  Die einzige bisher bekannte Wiederherstellungsoption ist es, die App neu zu laden.  Erstelle dazu eine Datei in myapp/frontend/src/hooks.client.ts und füge den folgenden Code in die Datei ein.

```
import { WindowReloadApp } from '$lib/wailsjs/runtime/runtime' 
export async function handleError() {
	WindowReloadApp()
}
```

##### Formulare und Bearbeitungsfunktionen verwenden

- Der einfachste Weg ist, eine Funktion vom Formular aus aufzurufen, welche der Standard ist. Binde deine Variablen mit `bind:value` und verhindere das Absenden mit `<form method="POST" on:submit|preventDefault={handle}>`
- Der fortgeschrittenere Weg ist use:enhance (progressive Erweiterung), was einen bequemen Zugriff auf Formatierdaten, formElement, Absender ermöglicht.  Wichtig ist es, das Formular, das das Verhalten auf Serverseite verhindert, immer zu annullieren.  https://kit.svelte.dev/docs/form-actions#progressive-enhancement Beispiel:

```
<form method="POST" use:enhance={({cancel, formData, formElement, submitter}) => {
	cancel()
	console.log(Object.fromEntries(formData))
	console.log(formElement)
	console.log(submitter)
	handle()
}}>
```
