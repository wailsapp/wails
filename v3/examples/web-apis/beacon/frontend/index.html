<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beacon API Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #4ade80; margin-bottom: 10px; }
        .description { color: #aaa; margin-bottom: 30px; }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 { font-size: 1.2rem; margin-bottom: 15px; color: #e94560; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #1a1a2e;
            color: #eee;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        button {
            background: #4ade80;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background: #60a5fa; }
        button.danger { background: #f87171; }
        .status { padding: 10px; border-radius: 6px; margin-bottom: 20px; }
        .status.success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .status.error { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .beacon-list {
            background: #0a0a1a;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .beacon-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #4ade80;
        }
        .beacon-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .beacon-id { color: #4ade80; font-weight: bold; }
        .beacon-time { color: #888; }
        .beacon-meta { color: #aaa; font-size: 0.85rem; margin-bottom: 8px; }
        .beacon-body {
            background: #1a1a2e;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
        }
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .stat {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #4ade80; }
        .stat-label { font-size: 0.8rem; color: #888; }
        .quick-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Beacon API Demo</h1>
        <p class="description">
            The Beacon API sends fire-and-forget requests to a server. This demo includes a local
            server that receives and displays the beacon data so you can see what arrives.
        </p>

        <div id="status" class="status success">
            Beacon API: <span id="available">checking...</span> |
            Server: <span id="serverStatus">http://localhost:9999/beacon</span>
        </div>

        <div class="card">
            <h2>Send Beacon</h2>
            <div class="quick-buttons">
                <button onclick="sendQuickBeacon('pageview')">Page View</button>
                <button onclick="sendQuickBeacon('click')" class="secondary">Click Event</button>
                <button onclick="sendQuickBeacon('error')" class="danger">Error Report</button>
                <button onclick="sendQuickBeacon('timing')" class="secondary">Timing Data</button>
            </div>
            <label for="customData">Custom JSON Data:</label>
            <textarea id="customData" rows="4">{
  "event": "custom",
  "data": "Hello from Beacon API!"
}</textarea>
            <button onclick="sendCustomBeacon()">Send Custom Beacon</button>
        </div>

        <div class="card">
            <h2>Received Beacons</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="beaconCount">0</div>
                    <div class="stat-label">Received</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalBytes">0</div>
                    <div class="stat-label">Total Bytes</div>
                </div>
            </div>
            <button onclick="refreshBeacons()">Refresh</button>
            <button onclick="clearBeacons()" class="danger">Clear All</button>
            <div class="beacon-list" id="beaconList">
                <div class="empty-state">No beacons received yet. Send one above!</div>
            </div>
        </div>

        <div class="card">
            <h2>How It Works</h2>
            <div style="color: #aaa; font-size: 0.9rem; line-height: 1.6;">
                <p><strong>1.</strong> The Wails app starts a local HTTP server on port 9999</p>
                <p><strong>2.</strong> When you click a button, <code>navigator.sendBeacon()</code> sends data to the server</p>
                <p><strong>3.</strong> The server receives the POST request and stores the data</p>
                <p><strong>4.</strong> Click "Refresh" or the list auto-updates to show received beacons</p>
                <p style="margin-top: 10px; color: #fbbf24;">
                    <strong>Note:</strong> Beacons are fire-and-forget - there's no response.
                    The API returns true/false only to indicate if the request was queued.
                </p>
            </div>
        </div>
    </div>

    <script>
        const BEACON_URL = 'http://localhost:9999/beacon';
        let autoRefreshInterval = null;

        function checkSupport() {
            const available = 'sendBeacon' in navigator;
            document.getElementById('available').textContent = available ? 'Supported' : 'Not supported';
            document.getElementById('status').className = available ? 'status success' : 'status error';
            return available;
        }

        function sendQuickBeacon(type) {
            let data;
            switch (type) {
                case 'pageview':
                    data = {
                        event: 'page_view',
                        page: window.location.pathname,
                        timestamp: Date.now()
                    };
                    break;
                case 'click':
                    data = {
                        event: 'click',
                        element: 'button',
                        timestamp: Date.now()
                    };
                    break;
                case 'error':
                    data = {
                        event: 'error',
                        message: 'Example error message',
                        stack: 'Error: Example\n    at line 42',
                        timestamp: Date.now()
                    };
                    break;
                case 'timing':
                    data = {
                        event: 'performance',
                        loadTime: performance.now().toFixed(2),
                        timestamp: Date.now()
                    };
                    break;
            }

            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const result = navigator.sendBeacon(BEACON_URL, blob);
            console.log(`Beacon ${type} queued: ${result}`);

            // Auto-refresh after a short delay
            setTimeout(refreshBeacons, 100);
        }

        function sendCustomBeacon() {
            const textarea = document.getElementById('customData');
            try {
                const data = JSON.parse(textarea.value);
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const result = navigator.sendBeacon(BEACON_URL, blob);
                console.log(`Custom beacon queued: ${result}`);
                setTimeout(refreshBeacons, 100);
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        }

        async function refreshBeacons() {
            try {
                const beacons = await window.wails.Call.BeaconService.GetBeacons();
                renderBeacons(beacons || []);
            } catch (e) {
                console.error('Failed to fetch beacons:', e);
            }
        }

        async function clearBeacons() {
            try {
                await window.wails.Call.BeaconService.ClearBeacons();
                refreshBeacons();
            } catch (e) {
                console.error('Failed to clear beacons:', e);
            }
        }

        function renderBeacons(beacons) {
            const list = document.getElementById('beaconList');
            document.getElementById('beaconCount').textContent = beacons.length;

            const totalBytes = beacons.reduce((sum, b) => sum + b.size, 0);
            document.getElementById('totalBytes').textContent = totalBytes;

            if (beacons.length === 0) {
                list.innerHTML = '<div class="empty-state">No beacons received yet. Send one above!</div>';
                return;
            }

            // Show newest first
            const sorted = [...beacons].reverse();

            list.innerHTML = sorted.map(beacon => {
                let formattedBody = beacon.body;
                try {
                    const parsed = JSON.parse(beacon.body);
                    formattedBody = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    // Not JSON, show as-is
                }

                return `
                    <div class="beacon-item">
                        <div class="beacon-header">
                            <span class="beacon-id">#${beacon.id}</span>
                            <span class="beacon-time">${beacon.timestamp}</span>
                        </div>
                        <div class="beacon-meta">
                            Content-Type: ${beacon.contentType || 'none'} | Size: ${beacon.size} bytes
                        </div>
                        <div class="beacon-body">${escapeHtml(formattedBody)}</div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        checkSupport();

        // Wait for Wails to be ready
        if (window.wails) {
            refreshBeacons();
            // Auto-refresh every 2 seconds
            autoRefreshInterval = setInterval(refreshBeacons, 2000);
        } else {
            window.addEventListener('wails:ready', () => {
                refreshBeacons();
                autoRefreshInterval = setInterval(refreshBeacons, 2000);
            });
        }
    </script>
</body>
</html>
